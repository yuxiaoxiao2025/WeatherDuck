# M1.5 Electron应用框架搭建

## 任务概述

**任务目标**: 建立完整的Electron主进程和渲染进程基础架构，实现安全的进程间通信机制，为桌面版应用提供稳定的运行环境。

**任务范围**: 
- 配置Electron主进程架构和生命周期管理
- 实现安全的contextBridge和preload脚本
- 建立IPC通信机制和API接口
- 配置窗口管理和应用元数据
- 实现开发环境集成和调试支持

## 技术方案依赖

### 来源：`技术方案v1.0.md`

#### 桌面版架构设计
> **主进程 (Main Process)**
> - 负责应用生命周期管理
> - 处理系统托盘和窗口控制
> - 管理SQLite数据库连接和文件系统操作
> - 处理自动更新逻辑和系统集成
>
> **渲染进程 (Renderer Process)**
> - 运行React应用
> - 处理用户交互和UI渲染
> - 管理前端状态和动画效果
> - 通过IPC与主进程通信

#### 进程间通信设计
> **进程间通信 (IPC)**
> - 使用Electron的contextBridge确保安全通信
> - 实现前后端数据交换
> - 处理异步操作和事件传递

#### 技术栈要求
> **桌面框架**: Electron 28+
> **进程通信**: Electron IPC
> **系统集成**: Electron原生API（托盘、通知、文件系统）
> **打包工具**: electron-builder

## 原型设计依赖

### 来源：`天气鸭-原型.html`

#### 窗口规格要求
- 应用窗口尺寸：375x812px（移动端优先设计）
- 最小窗口尺寸：350x500px
- 支持窗口拖拽和基础控制

#### 系统集成需求
- 系统托盘集成
- 后台运行支持
- 原生通知功能

## 现有代码依赖

### 主进程代码
- `src/main/main.ts` - 已有基础主进程框架，需要完善和优化
- `src/main/preload.ts` - 已有基础preload脚本，需要扩展API接口

### 配置文件
- `package.json` - Electron相关依赖和脚本配置
- `forge.config.ts` - Electron Forge打包配置
- `vite.config.ts` - 需要配置Electron构建支持

### 共享服务
- `src/shared/services/WeatherService.ts` - 天气服务，需要通过IPC暴露
- `src/shared/services/DatabaseService.ts` - 数据库服务，需要主进程集成

## 实施步骤

### 步骤1：完善主进程架构
- 优化 `src/main/main.ts` 的应用生命周期管理
- 实现单实例运行限制（`app.requestSingleInstanceLock()`）
- 配置窗口属性和安全设置
- 添加应用图标和元数据配置

### 步骤2：增强preload脚本安全性
- 扩展 `src/main/preload.ts` 的API接口定义
- 实现类型安全的IPC通信封装
- 添加错误处理和参数验证
- 创建统一的API响应格式

### 步骤3：建立完整的IPC通信机制
- 扩展现有的IPC处理程序
- 实现双向通信支持（主进程 → 渲染进程）
- 添加事件监听和广播机制
- 实现异步操作的状态管理

### 步骤4：配置窗口管理系统
- 实现窗口状态持久化（位置、大小）
- 添加窗口最小化到托盘功能
- 配置窗口图标和标题栏样式
- 实现窗口焦点和显示状态管理

### 步骤5：集成开发环境支持
- 配置开发者工具自动打开
- 实现热重载和自动刷新
- 添加开发环境检测和配置
- 集成调试工具和日志系统

### 步骤6：实现应用安全最佳实践
- 禁用Node.js集成（`nodeIntegration: false`）
- 启用上下文隔离（`contextIsolation: true`）
- 配置内容安全策略（CSP）
- 实现安全的外部链接处理

### 步骤7：添加错误处理和日志
- 实现全局错误捕获机制
- 添加主进程和渲染进程错误监听
- 配置日志记录和文件输出
- 实现崩溃报告和恢复机制

### 步骤8：配置应用菜单和快捷键
- 创建原生应用菜单
- 实现常用功能的快捷键
- 添加上下文菜单支持
- 配置系统托盘菜单

### 步骤9：验证和测试
- 测试应用启动和关闭流程
- 验证IPC通信的稳定性和性能
- 测试窗口管理功能
- 验证开发环境集成效果

## 验收标准

### 功能验收标准
- [ ] Electron应用可以正常启动和关闭
- [ ] 主进程和渲染进程通信正常
- [ ] 窗口管理功能完整（最小化、关闭、拖拽）
- [ ] 应用图标和元数据正确显示
- [ ] 单实例运行限制生效
- [ ] 开发者工具集成正常
- [ ] 外部链接安全处理
- [ ] 错误处理机制有效

### 技术验收标准
- [ ] 符合Electron安全最佳实践
- [ ] IPC通信类型安全
- [ ] 代码结构清晰，易于维护
- [ ] 性能指标达标（启动时间 < 3秒）
- [ ] 内存使用合理（< 100MB）
- [ ] 支持热重载开发
- [ ] 日志记录完整
- [ ] 错误恢复机制可靠

### 用户验收标准
- [ ] 应用启动速度快，响应流畅
- [ ] 窗口操作符合系统习惯
- [ ] 应用图标和界面美观
- [ ] 错误提示友好易懂
- [ ] 开发调试体验良好

## 风险识别与应对

### 技术风险
- **安全配置复杂**: 可能导致安全漏洞
  - *应对*: 严格遵循Electron安全指南，进行安全审计
- **IPC通信性能**: 大量数据传输可能影响性能
  - *应对*: 实现数据分页和缓存机制
- **跨平台兼容性**: 不同操作系统行为差异
  - *应对*: 在多平台环境下充分测试

### 开发风险
- **调试复杂度**: 多进程调试困难
  - *应对*: 配置完善的调试工具和日志系统
- **热重载稳定性**: 开发环境可能不稳定
  - *应对*: 实现渐进式重载和错误恢复

## 依赖关系

**前置依赖**: M1.4 (平台适配层架构设计与实现)
**后续任务**: M1.7 (React + TypeScript + Tailwind CSS共享架构), M1.8 (双平台数据存储方案设计与实现)

## 成功指标

- **启动性能**: 应用启动时间 < 3秒
- **内存使用**: 运行时内存占用 < 100MB
- **稳定性**: 连续运行24小时无崩溃
- **开发效率**: 热重载响应时间 < 2秒
- **安全性**: 通过Electron安全扫描
- **兼容性**: 专为Windows 10+平台优化

## 后续任务

- **M1.6**: Web版PWA配置与浏览器适配
- **M1.7**: React + TypeScript + Tailwind CSS共享架构
- **M1.8**: 双平台数据存储方案设计与实现
- **M2.5**: 高级窗口控制功能实现（桌面版专用）
- **M2.6**: 系统托盘集成（桌面版专用）