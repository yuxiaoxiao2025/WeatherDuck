# M1.2 任务文档：预览环境部署配置

## 任务概述

**任务ID**: M1.2  
**任务名称**: 预览环境部署配置  
**所属里程碑**: M1 - 双目标基础架构与CI/CD  
**预估工期**: 1天  
**负责角色**: 智慧体 #8 (预览环境)  
**优先级**: 高  

## 任务目标

配置预览环境的自动化部署，确保每次代码提交后能自动部署到可访问的预览地址，为天气鸭项目的双目标架构（桌面版+Web版）提供稳定的预览环境基础设施。

## 任务范围

### 包含内容
- 配置 `vercel.json` 部署配置文件
- 设置GitHub Actions预览环境自动部署
- 实现Web版自动部署到预览环境
- 配置环境变量和部署参数
- 验证预览环境可正常访问和更新

### 不包含内容
- 生产环境部署配置（在M4中处理）
- 桌面版应用的分发配置（在M4中处理）
- 域名和SSL证书配置（在M4中处理）

## 技术方案上下文

### 来自技术方案v1.0.md的相关内容

> **预览环境驱动的三环境架构**：
> 
> 开发环境 (Development) → 预览环境 (Staging) → 生产环境 (Production)
> 
> **预览环境是敏捷开发的核心枢纽**，承担以下关键职责：
> 1. **里程碑验证**: 每个开发里程碑完成后自动部署到预览环境
> 2. **团队协作**: 为设计师、产品经理提供实时可访问的演示环境
> 3. **质量保证**: 在生产环境发布前进行最终验证

> **多目标混合架构**模式，支持桌面应用和Web预览两种部署形态：
> - **灵活部署**: 支持桌面安装包和在线预览两种使用方式
> - **渐进式体验**: 用户可先通过Web版体验，再决定是否安装桌面版

> **Web版架构 (Browser)**:
> - 直接在浏览器中运行React应用
> - 使用浏览器原生API替代Electron功能
> - 通过localStorage和IndexedDB进行数据持久化
> - 支持PWA特性，提供类原生应用体验

### 项目结构
```
项目根目录
├── src/                    # 共享源代码
├── src-web/              # Web版特定代码
├── dist-web/            # Web版构建输出
├── .github/workflows/    # CI/CD配置
└── vercel.json          # Vercel部署配置
```

## 原型设计上下文

### 来自天气鸭-原型.html的相关内容

原型设计展示了Web版应用的核心功能：
- 响应式布局设计，适配不同屏幕尺寸
- 浏览器地理定位API集成
- PWA功能支持（离线访问、安装提示）
- 现代化的UI组件和交互效果

预览环境需要完整支持这些功能的在线演示。

## 现有代码依赖

### 关键文件
- <mcfile name="deploy-staging.yml" path="e:\trae\WeatherDuck\.github\workflows\deploy-staging.yml"></mcfile> - 现有的预览环境部署配置
- <mcfile name="DEPLOYMENT.md" path="e:\trae\WeatherDuck\DEPLOYMENT.md"></mcfile> - 部署指南文档
- <mcfile name="package.json" path="e:\trae\WeatherDuck\package.json"></mcfile> - 项目依赖和构建脚本
- <mcfile name=".env.example" path="e:\trae\WeatherDuck\.env.example"></mcfile> - 环境变量模板

### 构建配置
- Vite多目标构建配置已在M1.1中建立
- Web版构建输出目录：`dist-web/`
- PWA配置已在项目中预设

## 实施步骤

### 步骤1：创建Vercel部署配置文件
```json
{
  "version": 2,
  "name": "weatherduck-preview",
  "builds": [
    {
      "src": "dist-web/**",
      "use": "@vercel/static"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/dist-web/$1"
    }
  ],
  "env": {
    "VITE_APP_ENV": "staging",
    "VITE_ENABLE_PWA": "true"
  }
}
```

### 步骤2：配置GitHub Actions预览环境部署
更新现有的 `deploy-staging.yml` 文件：
- 添加Vercel部署步骤
- 配置环境变量传递
- 设置部署触发条件（main分支推送）

### 步骤3：设置Vercel项目和GitHub集成
- 在Vercel平台创建项目
- 连接GitHub仓库
- 配置自动部署触发器

### 步骤4：配置环境变量
在GitHub Secrets中添加：
- `VERCEL_TOKEN` - Vercel API令牌
- `VERCEL_ORG_ID` - Vercel组织ID
- `VERCEL_PROJECT_ID` - Vercel项目ID

### 步骤5：验证Web版构建流程
- 确保 `npm run build:web` 命令正常工作
- 验证构建产物在 `dist-web/` 目录
- 检查PWA配置文件生成

### 步骤6：测试预览环境部署
- 提交代码触发自动部署
- 验证部署成功并获取预览URL
- 测试Web版应用功能完整性

### 步骤7：文档更新和团队通知
- 更新DEPLOYMENT.md文档
- 记录预览环境访问地址
- 通知团队成员预览环境可用

## 验收标准

### 功能验收
- [ ] Vercel部署配置文件创建完成
- [ ] GitHub Actions预览环境自动部署配置完成
- [ ] Web版应用可以成功构建并部署到预览环境
- [ ] 预览环境URL可以正常访问
- [ ] PWA功能在预览环境中正常工作

### 技术验收
- [ ] 每次main分支代码提交自动触发预览环境部署
- [ ] 部署过程无错误，构建时间控制在5分钟内
- [ ] 预览环境支持HTTPS访问
- [ ] 环境变量正确传递到预览环境
- [ ] 构建产物大小合理（< 10MB）

### 用户验收
- [ ] 团队成员可以通过预览URL访问最新版本
- [ ] 预览环境响应速度良好（首屏加载 < 3秒）
- [ ] 移动端和桌面端浏览器兼容性良好
- [ ] PWA安装功能在预览环境中可用

## 风险与依赖

### 技术风险
- **Vercel服务可用性**: 依赖第三方平台，可能存在服务中断风险
- **构建失败**: Web版构建配置可能存在问题
- **环境变量泄露**: 需要妥善管理敏感配置信息

### 依赖关系
- **前置依赖**: M1.1 DevOps初始化完成，CI/CD流水线可用
- **后续依赖**: M1.3-M1.13的所有任务都依赖预览环境进行验证

### 缓解措施
- 准备备用部署平台（Netlify）作为后备方案
- 建立完整的环境变量管理流程
- 设置部署状态监控和告警机制

## 成功指标

- **部署成功率**: 95%以上的代码提交能成功部署到预览环境
- **部署速度**: 从代码提交到预览环境更新完成 < 5分钟
- **访问性能**: 预览环境首屏加载时间 < 3秒
- **可用性**: 预览环境月度可用性 > 99%

## 后续任务

完成本任务后，将为以下任务提供基础：
- M1.3: 双目标项目初始化和开发环境搭建
- M1.4-M1.13: 所有后续开发任务的预览环境验证
- M2-M4: 各里程碑的功能演示和验收

---

**备注**: 本任务是敏捷开发流程的关键基础设施，确保每个开发里程碑都能通过预览环境进行及时验证和反馈收集。