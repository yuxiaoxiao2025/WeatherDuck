# M1.9 和风天气API集成服务

## 任务概述

**任务目标**: 集成和风天气API，实现天气数据获取、缓存和错误处理机制，支持桌面版和Web版，提供完整的天气数据服务接口。

**任务范围**: 
- 配置和风天气API密钥和端点
- 实现当前天气、预报、城市搜索等API接口
- 建立智能缓存策略和数据验证机制
- 实现API限流、错误重试和离线处理
- 创建统一的天气数据服务层
- 集成地理定位和城市管理功能
- 实现网络状态检测和降级处理
- 编写完整的测试覆盖

## 技术方案依赖

### 来源：`技术方案v1.0.md`

#### 和风天气API集成配置
> **API端点配置**
> ```typescript
> const QWEATHER_CONFIG = {
>   baseUrl: 'https://devapi.qweather.com/v7',
>   endpoints: {
>     currentWeather: '/weather/now',
>     forecast: '/weather/7d',
>     hourlyForecast: '/weather/24h',
>     citySearch: '/city/lookup',
>     geoLocation: '/city/geoip'
>   }
> };
> ```

#### 数据映射和缓存策略
> - 当前天气数据：缓存30分钟
> - 天气预报数据：缓存2小时
> - 城市搜索结果：缓存24小时
> - 实现智能缓存更新机制

#### 和风天气GeoAPI集成
> ```typescript
> // 和风天气GeoAPI配置
> const QWEATHER_GEO_CONFIG = {
>   baseUrl: 'https://geoapi.qweather.com',
>   endpoints: {
>     cityLookup: '/v2/city/lookup',    // 城市搜索
>     cityTop: '/v2/city/top',          // 热门城市
>     poi: '/v2/poi/lookup',            // POI搜索
>     range: '/v2/city/range'           // 范围搜索
>   },
>   apiKey: process.env.QWEATHER_API_KEY
> };
> ```

#### 城市搜索接口设计
> ```typescript
> interface CitySearchParams {
>   location: string;     // 搜索关键词
>   adm?: string;        // 行政区划
>   range?: 'world' | 'cn' | 'us' | 'eu';  // 搜索范围
>   number?: number;     // 返回结果数量，1-20
>   lang?: 'zh' | 'en';  // 多语言
> }
> 
> interface LocationInfo {
>   name: string;        // 地区/城市名称
>   id: string;          // 地区/城市ID
>   lat: string;         // 地区/城市纬度
>   lon: string;         // 地区/城市经度
>   adm2: string;        // 地区/城市的上级行政区划名称
>   adm1: string;        // 地区/城市所属一级行政区域
>   country: string;     // 地区/城市所属国家名称
>   tz: string;          // 地区/城市所在时区
>   utcOffset: string;   // 地区/城市目前与UTC时间偏移的小时数
>   isDst: string;       // 地区/城市是否当前处于夏令时
>   type: string;        // 地区/城市的属性
>   rank: string;        // 地区评分
> }
> ```

#### 统一API接口层
> ```typescript
> interface WeatherDuckAPI {
>   // 天气数据
>   weather: {
>     getCurrent(cityId: string): Promise<CurrentWeatherData>;
>     getForecast(cityId: string, days: number): Promise<WeatherForecastData[]>;
>     getHourly(cityId: string): Promise<HourlyWeatherData[]>;
>   };
>   
>   // 城市管理
>   cities: {
>     search(query: string, options?: SearchOptions): Promise<CityInfo[]>;
>     getFavorites(): Promise<CityInfo[]>;
>     addFavorite(city: CityInfo): Promise<void>;
>     removeFavorite(cityId: string): Promise<void>;
>   };
> }
> ```

## API配置依赖

### 来源：`API_KEY_配置指南.md`

#### API Key配置要求
> **配置类型**: Web API（推荐）或桌面应用
> - Web API类型：配置最简单，无需填写域名或包名
> - 桌面应用类型：可以设置包名限制 `com.weatherwidget.desktop`

#### API端点修正
> 1. ✅ 将 `devapi.qweather.com` 改为 `api.qweather.com`（免费订阅端点）
> 2. ✅ 修复了城市搜索 API 的 URL（使用 `geoapi.qweather.com`）
> 3. ✅ 添加了详细的错误诊断工具

#### 常见错误处理
> - **403 Invalid Host**: API Key 没有正确配置应用类型
> - **404 错误**: 城市搜索使用不同域名 `geoapi.qweather.com`
> - **配额限制**: 免费订阅每日1000次请求

## 现有代码依赖

### 服务层代码
- `src/shared/services/WeatherService.ts` - 已有基础天气服务框架
- `src/main/main.ts` - Electron主进程，需要集成API服务
- `src/main/preload.ts` - 预加载脚本，需要暴露API接口

### 配置文件
- `package.json` - 需要添加axios等HTTP客户端依赖
- `.env` - 环境变量配置，存储API Key
- `vite.config.ts` - 构建配置，环境变量处理

### 项目结构
- `src/shared/` - 共享代码目录，API服务层
- `src/shared/types/` - TypeScript类型定义
- `src/shared/utils/` - 工具函数

## 实施步骤

### 步骤1：配置API环境和密钥
- 创建 `.env` 文件配置和风天气API Key
- 配置开发、测试、生产环境的不同端点
- 实现环境变量验证和错误提示
- 创建API配置管理模块
- 添加API Key安全性检查

### 步骤2：设计天气数据类型系统
- 创建 `src/shared/types/weather.ts` 定义所有天气数据接口
- 定义 `CurrentWeatherData` - 当前天气数据结构
- 定义 `WeatherForecastData` - 天气预报数据结构
- 定义 `HourlyWeatherData` - 小时级天气数据结构
- 定义 `CityInfo` - 城市信息数据结构
- 创建API响应和错误类型定义

### 步骤3：实现HTTP客户端封装
- 创建 `src/shared/services/HttpClient.ts` 统一HTTP客户端
- 配置axios实例和拦截器
- 实现请求/响应拦截器（API Key注入、错误处理）
- 添加请求重试机制和超时控制
- 实现请求日志和调试支持
- 配置跨平台网络适配

### 步骤4：实现和风天气API服务
- 重构 `src/shared/services/WeatherService.ts`
- 实现 `getCurrentWeather()` - 获取当前天气
- 实现 `getWeatherForecast()` - 获取天气预报
- 实现 `getHourlyForecast()` - 获取小时级预报
- 实现 `getWeatherIndices()` - 获取天气指数
- 添加数据验证和格式化

### 步骤5：实现城市搜索和地理服务
- 创建 `src/shared/services/GeoService.ts`
- 实现 `searchCities()` - 城市搜索功能
- 实现 `getHotCities()` - 获取热门城市
- 实现 `reverseGeocode()` - 坐标反查城市
- 实现 `getCurrentLocation()` - 获取当前位置
- 集成浏览器地理定位API

### 步骤6：建立智能缓存系统
- 创建 `src/shared/services/CacheService.ts`
- 实现分层缓存策略（内存缓存 + 持久化缓存）
- 配置不同数据类型的缓存时间
  - 当前天气：30分钟
  - 天气预报：2小时
  - 城市搜索：24小时
- 实现缓存失效和自动清理
- 添加缓存统计和监控

### 步骤7：实现API限流和错误处理
- 创建 `src/shared/services/RateLimiter.ts`
- 实现API请求频率限制
- 添加指数退避重试机制
- 实现网络状态检测
- 创建降级处理策略（离线模式）
- 添加详细的错误分类和处理

### 步骤8：集成数据存储适配器
- 集成M1.8的存储适配器
- 实现天气数据持久化缓存
- 添加离线数据支持
- 实现数据同步和更新机制
- 配置缓存清理和容量管理

### 步骤9：创建统一API服务层
- 创建 `src/shared/services/WeatherAPIService.ts` 统一服务入口
- 实现服务工厂模式和依赖注入
- 集成缓存、限流、错误处理等中间件
- 提供简洁的API接口给上层组件
- 实现服务状态监控和健康检查

### 步骤10：编写测试和文档
- 创建单元测试覆盖所有API接口
- 实现集成测试验证端到端流程
- 添加Mock服务支持离线开发
- 创建API使用文档和示例
- 实现API性能测试和监控

## 预览效果与演示价值

### 🎯 任务完成后的预览效果
**在预览环境中可以看到的变化**:
- Web版预览环境将显示真实的上海市宝山区天气数据，包括当前温度、天气状况、湿度、风速等信息
- 桌面版应用将展示相同的实时天气数据，数据来源于和风天气API
- 用户可以看到天气数据的实时刷新功能，点击刷新按钮后数据会更新
- 应用界面将显示数据加载状态，包括加载指示器和加载完成的反馈

### 💡 业务价值和用户价值
**对最终用户的价值**:
- 提供准确、实时的天气信息，帮助用户做出日常决策
- 支持离线查看缓存的天气数据，即使网络不稳定也能获取基本信息
- 快速的数据加载体验（<2秒），提升用户使用满意度
- 智能缓存机制减少数据流量消耗，节省用户成本

**对项目里程碑的贡献**:
- 实现M1里程碑的核心功能：基础天气信息显示
- 为后续里程碑的高级功能（动画、个性化等）提供数据基础
- 建立稳定的数据获取和缓存架构，支持双平台运行
- 验证和风天气API的可靠性和性能表现

### 📱 演示场景设计
**演示步骤**:
1. 打开Web版预览环境或启动桌面版应用，观察天气数据的自动加载
2. 展示当前天气信息：温度、天气状况图标、天气描述、湿度、风速等
3. 点击刷新按钮，演示数据更新过程和加载状态指示
4. 断开网络连接，验证离线模式下缓存数据的显示
5. 恢复网络连接，验证数据自动同步和更新功能

**关键演示点**:
- 真实天气数据的准确性和完整性
- 数据加载速度和用户体验流畅度
- 缓存机制的有效性和离线支持
- 错误处理的友好性和恢复能力
- 桌面版和Web版数据一致性

## 验收标准

### 功能验收标准
- [ ] 和风天气API密钥配置正确，所有端点正常访问
- [ ] 当前天气数据获取接口正常工作
- [ ] 7天天气预报数据获取接口正常工作
- [ ] 24小时天气预报数据获取接口正常工作
- [ ] 城市搜索和地理编码接口正常工作
- [ ] API响应数据验证和类型定义完整
- [ ] 智能缓存策略有效，提升响应速度
- [ ] API限流和错误重试机制正常
- [ ] 网络状态检测和离线处理完善
- [ ] 跨平台兼容性良好

### 技术验收标准
- [ ] API响应时间 < 2秒（网络正常情况下）
- [ ] 缓存命中率 > 80%，减少API调用次数
- [ ] 错误处理覆盖所有异常情况
- [ ] 内存使用合理，无内存泄漏
- [ ] TypeScript类型检查无错误
- [ ] 代码覆盖率 > 90%，测试通过率 100%
- [ ] API调用日志完整，便于调试
- [ ] 性能监控数据准确

### 用户验收标准
- [ ] 天气数据加载速度快，用户体验流畅
- [ ] 城市搜索响应及时，结果准确
- [ ] 离线模式下显示缓存数据
- [ ] 网络异常时有友好的错误提示
- [ ] 数据更新及时，信息准确可靠
- [ ] 多语言支持（中文/英文）

### 预览演示验收标准
- [ ] 预览环境中天气数据正常显示，信息完整准确
- [ ] 演示场景可以顺利执行，所有功能点都能展示
- [ ] 数据刷新和缓存机制在演示中得到有效验证
- [ ] 桌面版和Web版的天气数据显示一致性通过验证

## 风险识别与应对

### API服务风险
- **和风天气API稳定性**: 第三方服务可能不稳定
  - *应对*: 实现完善的重试机制和降级策略，缓存关键数据
- **API配额限制**: 免费版本每日1000次请求限制
  - *应对*: 实现智能缓存减少API调用，监控使用量
- **API Key安全性**: API密钥可能泄露
  - *应对*: 使用环境变量，避免硬编码，实现密钥轮换

### 技术实现风险
- **网络连接问题**: 用户网络环境复杂
  - *应对*: 实现网络状态检测，提供离线模式
- **数据格式变化**: API返回格式可能更新
  - *应对*: 实现数据验证和版本兼容性处理
- **跨平台兼容性**: 不同平台网络API差异
  - *应对*: 使用统一的HTTP客户端，做好平台适配

### 性能风险
- **缓存策略复杂性**: 缓存逻辑可能影响性能
  - *应对*: 简化缓存策略，实现性能监控
- **内存使用**: 大量缓存数据可能占用内存
  - *应对*: 实现内存限制和自动清理机制

## 依赖关系

**前置依赖**: M1.8 (双平台数据存储方案设计与实现)
**并行任务**: M1.10 (应用状态管理系统)
**后续任务**: M1.11 (天气数据展示组件开发), M1.12 (用户交互功能实现)

## 成功指标

- **API性能**: 响应时间 < 2秒，成功率 > 99%
- **缓存效率**: 命中率 > 80%，减少API调用 > 70%
- **错误处理**: 异常覆盖率 100%，用户友好错误提示
- **数据准确性**: 天气数据准确率 > 95%，城市搜索准确率 > 90%
- **用户体验**: 数据加载时间 < 3秒，离线可用性 > 80%
- **代码质量**: 测试覆盖率 > 90%，TypeScript类型安全
- **资源使用**: 内存占用 < 50MB，网络流量优化 > 60%
- **兼容性**: 支持主流浏览器和Electron环境

## 后续任务

- **M1.10**: 应用状态管理系统
- **M1.11**: 天气数据展示组件开发
- **M1.12**: 用户交互功能实现
- **M2.1**: 天气数据可视化和图表
- **M2.2**: 高级天气功能（预警、指数等）
- **M3.1**: 性能优化和缓存策略
- **M3.2**: 错误监控和日志系统
- **M4.3**: API服务监控和告警