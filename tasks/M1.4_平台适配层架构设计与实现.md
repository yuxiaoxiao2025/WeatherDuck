# M1.4 平台适配层架构设计与实现

## 任务概述

**任务目标**: 设计并实现平台适配层，抽象化桌面版和Web版的差异，提供统一的API接口，确保核心业务逻辑可以在两个平台间共享。

**任务范围**:
- 设计平台适配器接口规范
- 实现存储适配器（桌面版SQLite + Web版浏览器存储）
- 实现通知适配器（桌面版Electron + Web版Notification API）
- 实现音频适配器（统一音频播放接口）
- 实现窗口控制适配器（桌面版窗口操作 + Web版PWA）
- 实现地理位置适配器（统一定位服务接口）
- 实现适配器工厂模式，根据平台自动选择实现
- 编写适配器的单元测试

## 技术方案上下文

### 来自 `技术方案v1.0.md` 的相关内容

#### 多目标混合架构设计
```
┌─────────────────────────────────────────────────────────────────┐
│                    WeatherDuck 应用架构                          │
├─────────────────────────────────────────────────────────────────┤
│                 平台适配层 (Platform Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│                    共享业务逻辑层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   天气数据管理   │  │   城市数据管理   │  │   用户设置管理   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│    桌面版: SQLite + 文件系统    │    Web版: localStorage +     │
│                                │    IndexedDB + 动态API      │
└─────────────────────────────────────────────────────────────────┘
```

#### 平台适配层设计
- **存储适配器**: 
  - 桌面版: SQLite操作封装
  - Web版: localStorage + IndexedDB操作封装
- **通知适配器**:
  - 桌面版: Electron通知API
  - Web版: Web Notification API
- **音频适配器**:
  - 统一的音频播放接口
  - 支持音量控制和播放状态管理

#### 统一API接口层设计
```typescript
// 平台适配器接口
interface PlatformAdapter {
  storage: StorageAdapter;
  audio: AudioAdapter;
  notification: NotificationAdapter;
  geolocation: GeolocationAdapter;
  window: WindowAdapter;
}

// 桌面版适配器
class DesktopPlatformAdapter implements PlatformAdapter {
  storage = new DesktopStorageAdapter();
  audio = new DesktopAudioAdapter();
  notification = new DesktopNotificationAdapter();
  geolocation = new DesktopGeolocationAdapter();
  window = new DesktopWindowAdapter();
}

// Web版适配器
class WebPlatformAdapter implements PlatformAdapter {
  storage = new WebStorageAdapter();
  audio = new WebAudioAdapter();
  notification = new WebNotificationAdapter();
  geolocation = new WebGeolocationAdapter();
  window = new WebWindowAdapter();
}
```

### 来自 `天气鸭-原型.html` 的相关内容

#### 地理定位功能需求
- 浏览器地理定位API集成
- 用户权限管理和错误处理
- 定位状态的视觉反馈

#### 音频系统需求
- 布谷鸟报时音效播放
- 音量控制和播放状态管理
- 跨平台音频兼容性

#### 数据存储需求
- 用户设置持久化存储
- 城市信息和天气数据缓存
- 跨平台数据一致性

## 现有代码依赖

### 项目结构
- `src/shared/services/` - 共享服务层，需要通过适配器访问平台特定功能
- `src/main/` - Electron主进程代码
- `src/renderer/` - Electron渲染进程代码
- `src/web/` - Web版代码

### 相关配置文件
- `package.json` - 项目依赖和脚本配置
- `vite.config.ts` - Vite构建配置
- `forge.config.ts` - Electron Forge配置
- `tsconfig.json` - TypeScript配置

## 实施步骤

### 步骤1：创建适配器接口规范
- 创建 `src/adapters/types.ts` 定义所有适配器接口
- 定义统一的数据类型和错误处理规范
- 创建平台检测工具函数

### 步骤2：实现存储适配器
- 创建 `src/adapters/storage/` 目录
- 实现 `IStorageAdapter` 接口
- 桌面版：SQLite操作封装（`DesktopStorageAdapter`）
- Web版：localStorage + IndexedDB操作封装（`WebStorageAdapter`）

### 步骤3：实现通知适配器
- 创建 `src/adapters/notification/` 目录
- 实现 `INotificationAdapter` 接口
- 桌面版：Electron通知API封装（`DesktopNotificationAdapter`）
- Web版：Web Notification API封装（`WebNotificationAdapter`）

### 步骤4：实现音频适配器
- 创建 `src/adapters/audio/` 目录
- 实现 `IAudioAdapter` 接口
- 桌面版：Node.js音频处理（`DesktopAudioAdapter`）
- Web版：Web Audio API封装（`WebAudioAdapter`）

### 步骤5：实现窗口控制适配器
- 创建 `src/adapters/window/` 目录
- 实现 `IWindowAdapter` 接口
- 桌面版：Electron窗口控制（`DesktopWindowAdapter`）
- Web版：PWA窗口管理（`WebWindowAdapter`）

### 步骤6：实现地理位置适配器
- 创建 `src/adapters/geolocation/` 目录
- 实现 `IGeolocationAdapter` 接口
- 桌面版：Electron地理定位API（`DesktopGeolocationAdapter`）
- Web版：浏览器Geolocation API（`WebGeolocationAdapter`）

### 步骤7：实现适配器工厂模式
- 创建 `src/adapters/factory.ts`
- 实现平台检测逻辑
- 根据运行环境自动选择适配器实现
- 提供统一的适配器获取接口

### 步骤8：编写单元测试
- 创建 `tests/adapters/` 目录
- 为每个适配器编写单元测试
- 测试适配器接口的一致性
- 验证错误处理和边界情况

### 步骤9：集成验证和文档更新
- 在共享服务层集成适配器
- 验证适配器在两个平台上正常工作
- 更新技术文档和使用示例
- 创建适配器使用指南

## 验收标准

### 功能验收标准
- [ ] 所有适配器接口定义完整且一致
- [ ] 存储适配器在两个平台上功能一致
- [ ] 通知适配器能正常发送和管理通知
- [ ] 音频适配器支持播放控制和音量管理
- [ ] 窗口控制适配器提供统一的窗口操作接口
- [ ] 地理位置适配器能获取用户位置信息
- [ ] 适配器工厂能根据平台自动选择实现

### 技术验收标准
- [ ] 所有适配器遵循TypeScript接口规范
- [ ] 错误处理机制完善，提供友好的错误信息
- [ ] 适配器性能良好，无明显延迟
- [ ] 代码结构清晰，易于维护和扩展
- [ ] 单元测试覆盖率达到80%以上

### 用户验收标准
- [ ] 用户在两个平台上体验一致
- [ ] 数据在平台间保持一致性
- [ ] 功能切换无感知，响应及时
- [ ] 错误提示清晰，用户友好

## 风险识别

### 技术风险
- **平台API差异**: 不同平台的API可能存在功能差异，需要仔细处理兼容性
- **性能影响**: 适配层可能引入额外的性能开销
- **错误处理复杂性**: 需要统一处理不同平台的错误类型

### 依赖风险
- **M1.3**: 需要双目标项目初始化完成
- **技术栈稳定性**: 依赖Electron和Web API的稳定性

## 成功指标

- 适配器接口设计完整性：100%
- 平台功能一致性测试通过率：≥95%
- 单元测试覆盖率：≥80%
- 性能测试：适配层开销<10ms

## 后续任务

- M1.5: Electron应用框架搭建（依赖平台适配层）
- M1.6: Web版PWA配置与浏览器适配（依赖平台适配层）
- M1.8: 双平台数据存储方案设计与实现（使用存储适配器）

---

**创建时间**: 2024年12月
**负责人**: 开发团队
**预估工期**: 3-4天
**优先级**: 高