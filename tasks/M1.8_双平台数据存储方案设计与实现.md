# M1.8 双平台数据存储方案设计与实现

## 任务概述

**任务目标**: 设计并实现双平台的数据存储方案，桌面版使用SQLite数据库，Web版使用浏览器存储API（localStorage + IndexedDB），通过平台适配层提供统一接口，确保数据一致性和跨平台兼容性。

**任务范围**: 
- 设计统一的数据存储接口规范
- 实现桌面版SQLite数据库方案
- 实现Web版浏览器存储方案（localStorage + IndexedDB）
- 创建数据库表结构和索引设计
- 实现数据访问层（DAO）和存储适配器
- 建立数据迁移和版本管理机制
- 实现数据缓存策略和清理机制
- 确保跨平台数据一致性

## 技术方案依赖

### 来源：`技术方案v1.0.md`

#### 双目标架构数据持久层
> **数据持久层 (Data Layer)**
> - 桌面版: SQLite + 文件系统
> - Web版: localStorage + IndexedDB + 动态API
> - 通过平台适配层提供统一接口

#### SQLite数据库验证（桌面版）
> - **Context7库ID**: `/wiselibs/better-sqlite3`
> - **验证结果**: better-sqlite3是Node.js最快的SQLite库，拥有58个代码示例
> - **选型理由**:
>   - 轻量级嵌入式数据库，无需额外服务
>   - 同步API，简化开发复杂度
>   - 完整的事务支持
>   - 优秀的性能表现

#### 浏览器存储方案（Web版）
> **localStorage存储方案**：
> - 用于存储用户设置和应用配置
> - 持久化存储，浏览器关闭后数据保留
> - 同步API，读写性能优秀
> - 存储限制：通常5-10MB
>
> **IndexedDB存储方案**：
> - 用于存储城市数据和天气缓存
> - 支持复杂查询和索引
> - 异步API，不阻塞主线程
> - 存储限制：通常50MB-250MB或更多

#### 存储策略对比
> | 数据类型 | 桌面版(SQLite) | Web版存储方案 | 备注 |
> |---------|---------------|--------------|------|
> | 用户设置 | user_settings表 | localStorage | 轻量级配置数据 |
> | 城市收藏 | favorite_cities表 | localStorage | 用户个人数据 |
> | 城市数据 | cities表 | IndexedDB | 大量结构化数据 |
> | 天气缓存 | weather_cache表 | IndexedDB | 临时缓存数据 |

#### 平台适配层存储设计
> **存储适配器**: 
> - 桌面版: SQLite操作封装
> - Web版: localStorage + IndexedDB操作封装
> - 统一的存储接口和数据访问层
> - 支持数据迁移和版本管理

## 数据库设计依赖

### 来源：`技术方案v1.0.md`

#### 桌面版SQLite表结构

**用户设置表 (user_settings)**
```sql
CREATE TABLE user_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key VARCHAR(50) NOT NULL UNIQUE,
    value TEXT,
    data_type VARCHAR(20) DEFAULT 'string',
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**收藏城市表 (favorite_cities)**
```sql
CREATE TABLE favorite_cities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    city_id VARCHAR(20) NOT NULL,
    city_name VARCHAR(100) NOT NULL,
    country VARCHAR(50),
    province VARCHAR(50),
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    is_default BOOLEAN DEFAULT FALSE,
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**城市数据表 (cities)**
```sql
CREATE TABLE cities (
    city_id VARCHAR(20) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    full_name VARCHAR(200),
    province VARCHAR(50),
    city VARCHAR(50),
    county VARCHAR(50),
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    level VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**天气数据缓存表 (weather_cache)**
```sql
CREATE TABLE weather_cache (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    city_id VARCHAR(20) NOT NULL,
    data_type VARCHAR(20) NOT NULL,
    weather_data TEXT NOT NULL,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(city_id, data_type)
);
```

**应用配置表 (app_config)**
```sql
CREATE TABLE app_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key VARCHAR(50) NOT NULL UNIQUE,
    config_value TEXT,
    description TEXT,
    is_system BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 现有代码依赖

### 服务层代码
- `src/shared/services/WeatherService.ts` - 已有天气API服务，需要集成存储缓存
- `src/main/main.ts` - Electron主进程，需要集成SQLite数据库
- `src/main/preload.ts` - 预加载脚本，需要暴露数据库API

### 配置文件
- `package.json` - 需要添加better-sqlite3依赖
- `tsconfig.json` - TypeScript配置，已有路径别名
- `vite.config.ts` - 构建配置

### 项目结构
- `src/shared/` - 共享代码目录，需要添加存储适配器
- `src/renderer/` - 桌面版渲染进程
- `src/web/` - Web版代码

## 实施步骤

### 步骤1：设计统一存储接口
- 创建 `src/shared/types/storage.ts` 定义存储接口
- 定义 `IStorageAdapter` 统一存储接口
- 定义数据模型接口（`UserSettings`, `CityData`, `WeatherCache`等）
- 创建错误处理和异常类型定义
- 建立数据验证和序列化规范

### 步骤2：实现桌面版SQLite存储
- 安装并配置 `better-sqlite3` 数据库驱动
- 创建 `src/shared/storage/sqlite/` 目录
- 实现 `SqliteStorageAdapter` 类
- 创建数据库初始化脚本和表结构
- 实现数据库连接管理和事务支持
- 添加数据库迁移机制和版本控制

### 步骤3：实现Web版浏览器存储
- 创建 `src/shared/storage/web/` 目录
- 实现 `WebStorageAdapter` 类
- 实现 `LocalStorageManager` - localStorage操作封装
- 实现 `IndexedDBManager` - IndexedDB操作封装
- 创建浏览器存储的数据结构设计
- 实现数据序列化和反序列化

### 步骤4：创建数据访问层（DAO）
- 创建 `src/shared/dao/` 目录
- 实现 `UserSettingsDAO` - 用户设置数据访问
- 实现 `CityDAO` - 城市数据访问
- 实现 `WeatherCacheDAO` - 天气缓存数据访问
- 实现 `AppConfigDAO` - 应用配置数据访问
- 建立DAO工厂模式和依赖注入

### 步骤5：实现存储适配器工厂
- 创建 `src/shared/storage/StorageFactory.ts`
- 实现平台检测逻辑
- 实现适配器自动选择和初始化
- 配置存储适配器的单例模式
- 添加适配器切换和测试支持

### 步骤6：建立数据缓存策略
- 实现天气数据缓存机制
- 配置缓存过期时间和清理策略
- 实现缓存命中率统计
- 添加缓存预热和更新机制
- 实现离线数据支持

### 步骤7：实现数据迁移系统
- 创建数据库版本管理机制
- 实现数据迁移脚本和回滚支持
- 添加数据完整性检查
- 实现跨平台数据导入导出
- 建立数据备份和恢复机制

### 步骤8：集成Electron IPC接口
- 在 `src/main/main.ts` 中集成SQLite数据库
- 实现IPC处理器（`ipcMain.handle`）
- 在 `src/main/preload.ts` 中暴露数据库API
- 确保数据库操作的安全性和权限控制
- 添加数据库操作的错误处理

### 步骤9：实现存储性能优化
- 添加数据库连接池管理
- 实现批量操作和事务优化
- 配置索引和查询优化
- 添加存储容量监控和清理
- 实现数据压缩和存储优化

### 步骤10：编写测试和验证
- 创建单元测试覆盖所有存储操作
- 实现集成测试验证跨平台一致性
- 添加性能测试和压力测试
- 验证数据迁移和版本升级
- 测试错误处理和异常恢复

## 验收标准

### 功能验收标准
- [ ] 桌面版SQLite数据库正常工作，支持所有CRUD操作
- [ ] Web版localStorage和IndexedDB存储正常工作
- [ ] 统一存储接口在两个平台上行为一致
- [ ] 数据迁移和版本管理机制正常
- [ ] 缓存策略有效，提升应用性能
- [ ] 数据完整性和一致性得到保证
- [ ] 错误处理和异常恢复机制完善
- [ ] 存储容量管理和清理机制有效

### 技术验收标准
- [ ] SQLite数据库操作性能优秀（查询 < 50ms）
- [ ] IndexedDB操作响应及时（异步操作 < 100ms）
- [ ] 内存使用合理，无内存泄漏
- [ ] 数据库文件大小控制在合理范围
- [ ] 事务支持和数据一致性保证
- [ ] 索引设计优化，查询性能良好
- [ ] 代码覆盖率 > 85%，测试通过率 100%
- [ ] TypeScript类型检查无错误

### 用户验收标准
- [ ] 应用启动速度快，数据加载及时
- [ ] 用户设置保存和恢复正常
- [ ] 收藏城市管理功能完善
- [ ] 天气数据缓存提升用户体验
- [ ] 离线模式下基本功能可用
- [ ] 数据同步和更新透明无感知

## 风险识别与应对

### 技术风险
- **SQLite版本兼容性**: 不同平台SQLite版本差异
  - *应对*: 使用better-sqlite3统一SQLite版本，测试跨平台兼容性
- **IndexedDB浏览器支持**: 老版本浏览器可能不支持
  - *应对*: 实现功能降级，提供localStorage备选方案
- **数据迁移复杂性**: 版本升级时数据迁移可能失败
  - *应对*: 实现完善的备份和回滚机制

### 性能风险
- **大数据量处理**: 城市数据和缓存可能影响性能
  - *应对*: 实现分页查询和懒加载，优化索引设计
- **存储空间限制**: 浏览器存储容量限制
  - *应对*: 实现智能缓存清理和容量监控

### 数据安全风险
- **数据泄露**: 本地存储数据安全性
  - *应对*: 实现敏感数据加密，避免存储敏感信息
- **数据损坏**: 异常关闭可能导致数据损坏
  - *应对*: 实现数据完整性检查和自动修复

## 依赖关系

**前置依赖**: M1.4 (平台适配层架构设计与实现)
**并行任务**: M1.7 (React + TypeScript + Tailwind CSS共享架构)
**后续任务**: M1.9 (和风天气API集成服务), M1.11 (天气数据展示组件开发)

## 成功指标

- **性能指标**: SQLite查询 < 50ms，IndexedDB操作 < 100ms
- **存储效率**: 数据压缩率 > 30%，缓存命中率 > 80%
- **可靠性**: 数据一致性 100%，迁移成功率 > 99%
- **容量管理**: 桌面版数据库 < 100MB，Web版存储 < 50MB
- **开发效率**: API调用简洁，代码复用率 > 90%
- **测试覆盖**: 单元测试覆盖率 > 85%，集成测试通过率 100%
- **兼容性**: 支持SQLite 3.x，现代浏览器IndexedDB
- **用户体验**: 数据加载时间 < 2秒，离线功能可用

## 后续任务

- **M1.9**: 和风天气API集成服务
- **M1.11**: 天气数据展示组件开发
- **M1.12**: 用户交互功能实现
- **M3.6**: 双平台城市数据管理和缓存
- **M3.7**: 数据同步和离线支持
- **M4.1**: 性能优化和缓存策略
- **M4.2**: 数据安全和隐私保护