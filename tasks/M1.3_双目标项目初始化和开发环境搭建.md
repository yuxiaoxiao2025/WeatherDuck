# M1.3 任务文档：双目标项目初始化和开发环境搭建

## 任务概述

**任务ID**: M1.3  
**任务名称**: 双目标项目初始化和开发环境搭建  
**所属里程碑**: M1 - 双目标基础架构与CI/CD  
**预估工期**: 2天  
**负责角色**: 智慧体 #6 (前端架构师)  
**优先级**: 高  

## 任务目标

搭建双目标混合架构的开发环境，包括桌面版和Web版的项目结构、依赖管理、构建工具和代码规范，为天气鸭项目提供统一且高效的开发基础设施。

## 任务范围

### 包含内容
- 创建双目标项目结构 (`src/`, `src-electron/`, `src-web/`)
- 配置 TypeScript 5.x + React 18+ 开发环境
- 安装和配置 Tailwind CSS 样式框架
- 设置 Vite 多目标构建配置 (桌面版 + Web版)
- 配置 Electron 开发环境和热重载
- 创建 `package.json` 包含双目标构建脚本
- 编写项目 README.md 包含双目标开发指南
- 验证桌面版和Web版都能正常启动和构建

### 不包含内容
- 具体业务功能实现（在后续任务中处理）
- 平台适配层实现（在M1.4中处理）
- 生产环境优化配置（在M4中处理）

## 技术方案上下文

### 来自技术方案v1.0.md的相关内容

> **多目标混合架构**模式，支持桌面应用和Web预览两种部署形态：
> - **多平台支持**: 桌面版支持Windows、macOS、Linux，Web版支持所有现代浏览器
> - **统一代码库**: 共享核心业务逻辑和UI组件，降低维护成本
> - **现代化技术栈**: 基于React + Vite构建，支持热重载和快速开发

> **双目标架构层次**:
> ```
> ┌─────────────────────────────────────────────────────────────┐
> │                    用户界面层 (UI Layer)                      │
> │              React + TypeScript + Tailwind CSS              │
> ├─────────────────────────────────────────────────────────────┤
> │                  业务逻辑层 (Logic Layer)                     │
> │            状态管理 + API调用 + 数据处理 + 组件库              │
> ├─────────────────────────────────────────────────────────────┤
> │                  数据持久层 (Data Layer)                     │
> │    桌面版: SQLite + 文件系统    │    Web版: localStorage +     │
> │                                │    IndexedDB + 动态API      │
> ├─────────────────────────────────────────────────────────────┤
> │                 平台适配层 (Platform Layer)                   │
> │  桌面版: Electron Main Process  │  Web版: 浏览器API + PWA     │
> │         + IPC + 系统集成        │        + Service Worker     │
> └─────────────────────────────────────────────────────────────┘
> ```

### 项目结构设计
```
项目根目录
├── src/                    # 共享源代码
│   ├── components/         # 通用UI组件
│   ├── hooks/             # 自定义Hooks
│   ├── utils/             # 工具函数
│   ├── types/             # TypeScript类型定义
│   └── adapters/          # 平台适配器
├── src-electron/          # Electron主进程代码
├── src-web/              # Web版特定代码
├── dist-electron/        # 桌面版构建输出
├── dist-web/            # Web版构建输出
└── public/              # 静态资源
```

### 技术栈验证结果

> **Vite构建工具验证**:
> - **Context7库ID**: `/vitejs/vite`
> - 支持多目标构建配置（桌面版和Web版）
> - 热重载和快速开发体验
> - 原生ES模块支持，完美支持TypeScript和React

> **React框架验证**:
> - **Context7库ID**: `/reactjs/react.dev`
> - 推荐使用React 18+版本，支持并发特性和新的Hooks API
> - 组件化开发模式，代码复用性高

> **Tailwind CSS验证**:
> - **Context7库ID**: `/tailwindlabs/tailwindcss.com`
> - 实用优先的CSS框架，拥有1747个代码示例，信任分数10分

## 原型设计上下文

### 来自天气鸭-原型.html的相关内容

原型设计展示了应用的核心UI结构：
- 现代化的单页面应用设计
- 响应式布局，支持不同屏幕尺寸
- 组件化的UI结构（标题栏、天气显示、设置面板）
- 优雅的动画效果和交互体验

开发环境需要支持这些设计要求的实现。

## 现有代码依赖

### 关键文件
- <mcfile name="package.json" path="e:\trae\WeatherDuck\package.json"></mcfile> - 项目依赖和构建脚本
- <mcfile name="vite.config.ts" path="e:\trae\WeatherDuck\vite.config.ts"></mcfile> - Vite构建配置
- <mcfile name="tsconfig.json" path="e:\trae\WeatherDuck\tsconfig.json"></mcfile> - TypeScript配置
- <mcfile name="forge.config.ts" path="e:\trae\WeatherDuck\forge.config.ts"></mcfile> - Electron Forge配置
- <mcfile name=".env.example" path="e:\trae\WeatherDuck\.env.example"></mcfile> - 环境变量模板

### 现有配置状态
- 基础的Electron + React + Vite配置已存在
- TypeScript配置已建立
- 部分构建脚本已配置
- 需要完善双目标构建支持

## 实施步骤

### 步骤1：完善双目标项目结构
```bash
# 创建共享源代码目录
mkdir -p src/components src/hooks src/utils src/types src/adapters

# 创建平台特定目录
mkdir -p src-electron src-web

# 创建构建输出目录
mkdir -p dist-electron dist-web
```

### 步骤2：配置TypeScript 5.x + React 18+开发环境
更新 `tsconfig.json` 支持双目标编译：
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "paths": {
      "@/*": ["./src/*"],
      "@electron/*": ["./src-electron/*"],
      "@web/*": ["./src-web/*"]
    }
  },
  "include": ["src", "src-electron", "src-web"],
  "references": [
    { "path": "./tsconfig.node.json" }
  ]
}
```

### 步骤3：安装和配置Tailwind CSS
```bash
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
```

配置 `tailwind.config.js`:
```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
    "./src-web/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

### 步骤4：设置Vite多目标构建配置
创建多个Vite配置文件：

**vite.renderer.config.ts** (桌面版渲染进程):
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@electron': path.resolve(__dirname, './src-electron'),
    },
  },
  base: './',
});
```

**vite.web.config.ts** (Web版):
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  root: './src-web',
  build: {
    outDir: '../dist-web',
    emptyOutDir: true,
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@web': path.resolve(__dirname, './src-web'),
    },
  },
});
```

### 步骤5：配置Electron开发环境和热重载
更新 `forge.config.ts` 确保热重载配置正确：
```typescript
import type { ForgeConfig } from '@electron-forge/shared-types';
import { VitePlugin } from '@electron-forge/plugin-vite';

const config: ForgeConfig = {
  packagerConfig: {},
  rebuildConfig: {},
  makers: [
    {
      name: '@electron-forge/maker-squirrel',
      config: {},
    },
  ],
  plugins: [
    new VitePlugin({
      build: [
        {
          entry: 'src-electron/main.ts',
          config: 'vite.main.config.ts',
        },
        {
          entry: 'src-electron/preload.ts',
          config: 'vite.preload.config.ts',
        },
      ],
      renderer: [
        {
          name: 'main_window',
          config: 'vite.renderer.config.ts',
        },
      ],
    }),
  ],
};

export default config;
```

### 步骤6：更新package.json构建脚本
```json
{
  "scripts": {
    "dev": "electron-forge start",
    "dev:renderer": "vite src/renderer",
    "dev:web": "vite --config vite.web.config.ts",
    "build": "npm run build:renderer && npm run build:web",
    "build:renderer": "vite build src/renderer",
    "build:web": "vite build --config vite.web.config.ts",
    "preview:web": "vite preview --config vite.web.config.ts",
    "package": "electron-forge package",
    "make": "electron-forge make",
    "publish": "electron-forge publish",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "test": "vitest",
    "test:ci": "vitest run --coverage"
  }
}
```

### 步骤7：创建基础入口文件
**src-web/index.html**:
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>天气鸭 Web 预览版</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
```

**src-web/index.tsx**:
```typescript
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from '@/App';
import '@/index.css';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
);
```

### 步骤8：编写项目README.md
更新README.md包含双目标开发指南：
- 项目结构说明
- 开发环境搭建步骤
- 双目标构建命令
- 调试和测试指南

### 步骤9：验证双目标构建
```bash
# 验证桌面版开发环境
npm run dev

# 验证Web版开发环境
npm run dev:web

# 验证双目标构建
npm run build

# 验证Web版预览
npm run preview:web
```

## 验收标准

### 功能验收
- [ ] 双目标项目结构创建完成，目录结构清晰
- [ ] TypeScript 5.x + React 18+ 开发环境配置完成
- [ ] Tailwind CSS 样式框架安装和配置完成
- [ ] Vite 多目标构建配置完成，支持桌面版和Web版
- [ ] Electron 开发环境配置完成，热重载正常工作
- [ ] package.json 包含完整的双目标构建脚本
- [ ] README.md 包含详细的双目标开发指南

### 技术验收
- [ ] 桌面版应用可以正常启动和热重载
- [ ] Web版应用可以正常启动和热重载
- [ ] 双目标构建可以成功生成构建产物
- [ ] TypeScript 类型检查无错误
- [ ] ESLint 代码检查通过
- [ ] 路径别名配置正确，模块导入正常

### 用户验收
- [ ] 开发者可以同时开发桌面版和Web版
- [ ] 热重载响应速度快（< 1秒）
- [ ] 构建速度合理（桌面版 < 30秒，Web版 < 15秒）
- [ ] 开发体验良好，调试工具可用

## 风险与依赖

### 技术风险
- **依赖版本冲突**: React 18+和Electron可能存在兼容性问题
- **构建配置复杂**: 多目标构建配置可能导致配置文件复杂
- **热重载问题**: 双目标开发环境的热重载可能不稳定

### 依赖关系
- **前置依赖**: M1.1 DevOps初始化完成，基础CI/CD可用
- **前置依赖**: M1.2 预览环境配置完成，可以验证Web版构建
- **后续依赖**: M1.4-M1.13的所有开发任务都依赖本开发环境

### 缓解措施
- 使用经过验证的依赖版本组合
- 建立完整的构建验证流程
- 准备回退方案和故障排除指南

## 成功指标

- **构建成功率**: 95%以上的构建尝试成功
- **热重载速度**: 代码修改到页面更新 < 1秒
- **构建速度**: 桌面版构建 < 30秒，Web版构建 < 15秒
- **开发体验**: 开发者满意度评分 > 8/10

## 后续任务

完成本任务后，将为以下任务提供基础：
- M1.4: 平台适配层架构设计与实现
- M1.5: Electron应用框架搭建
- M1.6: Web版PWA配置与浏览器适配
- M1.7: React + TypeScript + Tailwind CSS共享架构

---

**备注**: 本任务是整个项目开发的基础设施，确保双目标架构的开发环境稳定可靠，为后续所有开发任务提供统一的技术基础。